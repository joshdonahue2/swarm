name: Deploy Stack on Change

on:
  push:
    paths:
      - 'stacks/**.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Python Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-yaml

      - name: Detect Changed Files and Deploy
        run: |
          # 1. Create a temporary Python script to extract service names
          # We do this here to avoid YAML syntax issues with inline code
          cat <<EOF > extract_services.py
          import yaml
          import sys
          
          try:
              with open(sys.argv[1], 'r') as f:
                  data = yaml.safe_load(f)
              
              if data and 'services' in data:
                  for s in data['services']:
                      # Clean the name to match folder structure
                      print(s.lower().replace(' ', ''))
          except Exception as e:
              # Silently fail or log if file is invalid, loop will just handle nothing
              pass
          EOF

          # 2. Find changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^stacks/.*\.yml$')
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No stack files changed."
            exit 0
          fi

          for FILE in $CHANGED_FILES; do
            echo "Processing $FILE..."
            STACK_NAME=$(basename "$FILE" .yml)
            
            # 3. Run the standardization script
            python3 scripts/standardize.py "$FILE" > deploy_generated.yml
            
            # 4. Auto-Create Folders
            # Run the temp script we made above against the current file
            python3 extract_services.py "$FILE" | while read SERVICE_SLUG; do
                TARGET_DIR="/mnt/shared/swarm/$SERVICE_SLUG"
                echo "Ensuring directory exists: $TARGET_DIR"
                sudo mkdir -p "$TARGET_DIR"
                sudo chown -R 1000:1000 "$TARGET_DIR"
            done

            # 5. Deploy
            echo "Deploying stack: $STACK_NAME"
            docker stack deploy -c deploy_generated.yml "$STACK_NAME"
            
            # Cleanup
            rm deploy_generated.yml
          done
          
          # Remove the temp script
          rm extract_services.py