name: Deploy Stack on Change

on:
  push:
    paths:
      - 'stacks/**.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # CHANGED: Use apt instead of pip for Debian 12 compatibility
      - name: Install Python Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-yaml

      - name: Detect Changed Files and Deploy
        run: |
          # Find changed files in 'stacks/'
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^stacks/.*\.yml$')
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No stack files changed."
            exit 0
          fi

          for FILE in $CHANGED_FILES; do
            echo "Processing $FILE..."
            STACK_NAME=$(basename "$FILE" .yml)
            
            # 1. Run the standardize script (using system python3)
            python3 scripts/standardize.py "$FILE" > deploy_generated.yml
            
            # 2. AUTO-CREATE FOLDERS
            # Extracts service name and creates /mnt/shared/swarm/<service>
            python3 -c "
import yaml
with open('$FILE') as f:
    d = yaml.safe_load(f)
    for s in d.get('services', {}):
        print(s.lower().replace(' ', ''))
            " | while read SERVICE_SLUG; do
                TARGET_DIR="/mnt/shared/swarm/$SERVICE_SLUG"
                echo "Ensuring directory exists: $TARGET_DIR"
                sudo mkdir -p "$TARGET_DIR"
                sudo chown -R 1000:1000 "$TARGET_DIR"
            done

            # 3. Deploy
            echo "Deploying stack: $STACK_NAME"
            docker stack deploy -c deploy_generated.yml "$STACK_NAME"
            
            # Cleanup
            rm deploy_generated.yml
          done