name: Deploy All Stacks

on:
  push:
    paths:
      - 'stacks/**'
      - 'scripts/**'
      - '.github/workflows/**'

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # --- REMOVED: setup-python step ---
      # --- REMOVED: pip install step ---

      - name: Process Stacks
        # We use 'python3' directly, relying on the package we installed in Step 1
        run: python3 scripts/process_stacks.py

      - name: Deploy to Swarm
        run: |
          echo "üöÄ Starting Deployment Loop..."
          
          # Check if any files exist to prevent errors if folder is empty
          if [ -d "ready_to_deploy" ]; then
            for file in ready_to_deploy/*.yml; do
              [ -e "$file" ] || continue # Handle case where glob matches nothing
              
              stack_name=$(basename "$file" .yml)
              
              echo "---------------------------------"
              echo "üê≥ Deploying Stack: $stack_name"
              
              docker stack deploy -c "$file" "$stack_name" --prune
            done
          else
            echo "‚ö†Ô∏è No stacks found to deploy."
          fi
          
          echo "‚úÖ All stacks updated!"