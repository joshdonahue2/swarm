name: Deploy All Stacks

on:
  push:
    paths:
      - 'stacks/**'
      - 'scripts/**'

jobs:
  deploy:
    runs-on: self-hosted  # Assuming you are using the local runner from previous steps

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install pyyaml

      - name: Process Stacks
        run: python scripts/process_stacks.py
        # This reads stacks/*.yml and saves them to ready_to_deploy/*.yml

      - name: Deploy to Swarm
        run: |
          echo "ğŸš€ Starting Deployment Loop..."
          
          # Loop through every file in the output folder
          for file in ready_to_deploy/*.yml; do
            # Extract filename without extension (e.g., 'plex.yml' -> 'plex')
            stack_name=$(basename "$file" .yml)
            
            echo "---------------------------------"
            echo "ğŸ³ Deploying Stack: $stack_name"
            
            # Deploy using the generated file
            docker stack deploy -c "$file" "$stack_name" --prune
            
          done
          
          echo "âœ… All stacks updated!"