name: Deploy All Stacks

on:
  push:
    paths:
      - 'stacks/**'
      - 'scripts/**'
      - '.github/workflows/**'

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # ---------------------------------------------------------
      # REMOVED the "Install Python Dependencies" step entirely.
      # We assume you ran the apt install command manually once.
      # ---------------------------------------------------------

      - name: Process Stacks
        # We just use the python3 installed on the system
        run: python3 scripts/process_stacks.py

      - name: Deploy to Swarm
        run: |
          echo "üöÄ Starting Deployment Loop..."
          
          if [ -d "ready_to_deploy" ]; then
            for file in ready_to_deploy/*.yml; do
              [ -e "$file" ] || continue
              
              stack_name=$(basename "$file" .yml)
              
              echo "---------------------------------"
              echo "üê≥ Deploying Stack: $stack_name"
              
              docker stack deploy -c "$file" "$stack_name" --prune
            done
          else
            echo "‚ö†Ô∏è No stacks found to deploy."
          fi
          
          echo "‚úÖ All stacks updated!"